name: 'Jira Issue Check'
inputs:
  branch-name:  # New input for the branch name
    description: 'The branch name passed from the calling workflow.'
    required: false
  jira-base-url:
    description: 'The base URL for the self-hosted Jira instance.'
    required: true
  jira-token:
    description: 'The API token for authentication.'
    required: true
  pr-body:
    description: 'Pull Request description'
    required: true
runs:
  using: "composite"
  steps:
    # - name: ðŸ“¦ Install utilities
    #   run: sudo apt-get update && sudo apt-get install -y jq curl
    - name: Validate PR Description Includes Issue Key
      id: extract_key
      shell: bash
      run: |
        PR_BODY="${{ inputs.pr-body }}"
        echo "PR Description received:"
        echo "$PR_BODY"

        ISSUE_KEYS=$(echo "$PR_BODY" | grep -oE '[A-Z]+-[0-9]+' | sort -u)
        
        if [[ -z "$ISSUE_KEYS" ]]; then
          echo "âŒ No Jira issue keys found in PR description."
          exit 1
        fi
    
        echo "âœ… PR description includes Jira key."
        KEYS_CSV=$(echo "$ISSUE_KEYS" | paste -sd "," -)
        echo "issue_key=$KEYS_CSV" >> $GITHUB_OUTPUT

    - name: ðŸ“ž Get Jira Issue Status and Validate
      if: steps.extract_key.outputs.issue_key != ''
      id: get_and_check_status
      shell: bash
      run: |
        FAIL=false
        IFS=',' read -ra KEYS <<< "${{ steps.extract_key.outputs.issue_key }}"
      
        for ISSUE_KEY in "${KEYS[@]}"; do
          echo "ðŸ” Checking Jira Issue: $ISSUE_KEY"
      
          JIRA_URL="${{ inputs.jira-base-url }}"
          JIRA_AUTH="${{ inputs.jira-token }}"
      
          HTTP_STATUS=$(curl -s -o /tmp/jira_response.json -w "%{http_code}" \
            --location --request GET "${JIRA_URL}/rest/api/2/issue/$ISSUE_KEY?fields=status" \
            --header 'Accept: application/json' \
            --header "Authorization: Bearer $JIRA_AUTH" )
      
          echo "Jira API HTTP Status: $HTTP_STATUS"
      
          if [ "$HTTP_STATUS" == "404" ]; then
            echo "âŒ Jira Issue $ISSUE_KEY not found."
            FAIL=true
            continue
          elif [ "$HTTP_STATUS" == "401" ]; then
            echo "âŒ Authentication failed."
            exit 1
          elif [ "$HTTP_STATUS" -ge "400" ]; then
            echo "âŒ Jira API returned $HTTP_STATUS."
            FAIL=true
            continue
          fi
      
          STATUS=$(jq -r '.fields.status.name' /tmp/jira_response.json)
          echo "âœ” $ISSUE_KEY Status: $STATUS"
      
          if [[ "$STATUS" != "Done" ]]; then
            echo "âŒ Issue $ISSUE_KEY is '$STATUS'. Must be 'Done'."
            FAIL=true
          else
            echo "âœ… $ISSUE_KEY is Done"
          fi
        done
      
        if [ "$FAIL" = true ]; then
          echo "âŒ One or more Jira issues are not 'Done'."
          exit 1
        else
          echo "ðŸŽ‰ All Jira issues are 'Done'!"
        fi
